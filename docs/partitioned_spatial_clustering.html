<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>13&nbsp; Spatially Constrained Clustering - Partitioning Methods – The Python Companion to Spatial Cluster Analysis with GeoDa</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./cluster_validation.html" rel="next">
<link href="./hierarchical_spatial_clustering.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./partitioned_spatial_clustering.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Spatially Constrained Clustering - Partitioning Methods</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">The Python Companion to Spatial Cluster Analysis with GeoDa</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Creating_maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Creating Thematic Maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Multivariate_local.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Multivariate Local Spatial Clusters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Density_cluster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Density Based Clustering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PCA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Principal Component Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./MDS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Distance Preserving Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Hierarchical Clustering Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Partitioning Clustering Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kmedoids.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Clustering Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spectral_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spectral Clustering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatializing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Spatializing Classic Clustering Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical_spatial_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatially Constrained Clustering - Hierarchical Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./partitioned_spatial_clustering.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Spatially Constrained Clustering - Partitioning Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cluster_validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Cluster Validation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link active" data-scroll-target="#preliminaries"><span class="header-section-number">13.1</span> Preliminaries</a>
  <ul class="collapse">
  <li><a href="#import-required-modules" id="toc-import-required-modules" class="nav-link" data-scroll-target="#import-required-modules"><span class="header-section-number">13.1.1</span> Import Required Modules</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data"><span class="header-section-number">13.1.2</span> Load Data</a></li>
  <li><a href="#variables" id="toc-variables" class="nav-link" data-scroll-target="#variables"><span class="header-section-number">13.1.3</span> Variables</a></li>
  <li><a href="#pygeoda-data-preparation" id="toc-pygeoda-data-preparation" class="nav-link" data-scroll-target="#pygeoda-data-preparation"><span class="header-section-number">13.1.4</span> Pygeoda Data Preparation</a></li>
  </ul></li>
  <li><a href="#azp" id="toc-azp" class="nav-link" data-scroll-target="#azp"><span class="header-section-number">13.2</span> AZP</a>
  <ul class="collapse">
  <li><a href="#azp-greedy" id="toc-azp-greedy" class="nav-link" data-scroll-target="#azp-greedy"><span class="header-section-number">13.2.1</span> AZP-Greedy</a></li>
  <li><a href="#azp-tabu" id="toc-azp-tabu" class="nav-link" data-scroll-target="#azp-tabu"><span class="header-section-number">13.2.2</span> AZP-Tabu</a></li>
  <li><a href="#azp-simulated-annealing" id="toc-azp-simulated-annealing" class="nav-link" data-scroll-target="#azp-simulated-annealing"><span class="header-section-number">13.2.3</span> AZP-Simulated Annealing</a></li>
  <li><a href="#arisel" id="toc-arisel" class="nav-link" data-scroll-target="#arisel"><span class="header-section-number">13.2.4</span> ARiSel</a></li>
  <li><a href="#azp-with-initial-clustering-result" id="toc-azp-with-initial-clustering-result" class="nav-link" data-scroll-target="#azp-with-initial-clustering-result"><span class="header-section-number">13.2.5</span> AZP with Initial Clustering Result</a></li>
  <li><a href="#comparing-azp-implementations" id="toc-comparing-azp-implementations" class="nav-link" data-scroll-target="#comparing-azp-implementations"><span class="header-section-number">13.2.6</span> Comparing AZP Implementations</a></li>
  </ul></li>
  <li><a href="#max-p-regions" id="toc-max-p-regions" class="nav-link" data-scroll-target="#max-p-regions"><span class="header-section-number">13.3</span> Max-p Regions</a>
  <ul class="collapse">
  <li><a href="#sensitivity-analysis" id="toc-sensitivity-analysis" class="nav-link" data-scroll-target="#sensitivity-analysis"><span class="header-section-number">13.3.1</span> Sensitivity Analysis</a></li>
  </ul></li>
  <li><a href="#practice" id="toc-practice" class="nav-link" data-scroll-target="#practice"><span class="header-section-number">13.4</span> Practice</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-spatialpartitioning" class="quarto-section-identifier"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Spatially Constrained Clustering - Partitioning Methods</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this Chapter, we continue with methods that impose <em>hard</em> spatial constraints in a clustering procedure. We consider two methods that use a partitioning clustering logic: <em>AZP</em> (automatic zoning procedure), <span class="citation" data-cites="Openshaw77">Openshaw (<a href="bibliography.html#ref-Openshaw77" role="doc-biblioref">1977</a>)</span> ,<span class="citation" data-cites="OpenshawRao95">Openshaw and Rao (<a href="bibliography.html#ref-OpenshawRao95" role="doc-biblioref">1995</a>)</span>, and <em>max-p</em>, <span class="citation" data-cites="Duqueetal12">Duque, Anselin, and Rey (<a href="bibliography.html#ref-Duqueetal12" role="doc-biblioref">2012</a>)</span>. Both are covered in Chapter 11 of the <em>GeoDa Cluster Book</em>.</p>
<p>As in <a href="hierarchical_spatial_clustering.html" class="quarto-xref">Chapter&nbsp;<span>12</span></a>, we need to rely on the functionality from <code>GeoDa</code> that is included in the <code>pygeoda</code> package. We again use the helper functions <code>ensure_datasets</code>, <code>cluster_stats</code>, <code>cluster_center</code>, <code>cluster_fit</code> and <code>cluster_map</code> from the <code>spatial-cluster-helper</code> package. We rely on <code>geopandas</code> and <code>numpy</code> for the basics. As in the previous chapter, we import <code>time</code> to get insight into the performance of the different algorithms.</p>
<p>We continue with the <strong>ceara</strong> sample data set for the empirical illustration.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Required Packages">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Required Packages
</div>
</div>
<div class="callout-body-container callout-body">
<p>geopandas, numpy, pygeoda, spatial-cluster-helper</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Required Data Sets">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Required Data Sets
</div>
</div>
<div class="callout-body-container callout-body">
<p>ceara</p>
</div>
</div>
<section id="preliminaries" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="preliminaries"><span class="header-section-number">13.1</span> Preliminaries</h2>
<section id="import-required-modules" class="level3" data-number="13.1.1">
<h3 data-number="13.1.1" class="anchored" data-anchor-id="import-required-modules"><span class="header-section-number">13.1.1</span> Import Required Modules</h3>
<div id="e49b893f" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spatial_cluster_helper <span class="im">import</span> ensure_datasets, cluster_stats, <span class="op">\</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>            cluster_fit, cluster_center, cluster_map</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygeoda</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-data" class="level3" data-number="13.1.2">
<h3 data-number="13.1.2" class="anchored" data-anchor-id="load-data"><span class="header-section-number">13.1.2</span> Load Data</h3>
<p>We load the <code>ceara.shp</code> shape file and do a quick check of its contents. For this sample data, we use the argument <code>encoding = 'utf-8'</code> in the <code>read_file</code> function to account for the special characters in Brazilian Portuguese.</p>
<div id="a2bd865b" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting working folder:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#path = "/your/path/to/data/"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"./datasets/"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the Ceará data:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>shpfile <span class="op">=</span> <span class="st">"ceara/ceara.shp"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>ensure_datasets(shpfile, folder_path <span class="op">=</span> path)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> gpd.read_file(path <span class="op">+</span> shpfile, encoding <span class="op">=</span> <span class="st">'utf-8'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dfs.shape)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>dfs.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(184, 36)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">code7</th>
<th data-quarto-table-cell-role="th">mun_name</th>
<th data-quarto-table-cell-role="th">state_init</th>
<th data-quarto-table-cell-role="th">area_km2</th>
<th data-quarto-table-cell-role="th">state_code</th>
<th data-quarto-table-cell-role="th">micro_code</th>
<th data-quarto-table-cell-role="th">micro_name</th>
<th data-quarto-table-cell-role="th">inc_mic_4q</th>
<th data-quarto-table-cell-role="th">inc_zik_3q</th>
<th data-quarto-table-cell-role="th">inc_zik_2q</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">gdp</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">gdpcap</th>
<th data-quarto-table-cell-role="th">popdens</th>
<th data-quarto-table-cell-role="th">zik_1q</th>
<th data-quarto-table-cell-role="th">ziq_2q</th>
<th data-quarto-table-cell-role="th">ziq_3q</th>
<th data-quarto-table-cell-role="th">zika_d</th>
<th data-quarto-table-cell-role="th">mic_d</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2300101.0</td>
<td>Abaiara</td>
<td>CE</td>
<td>180.833</td>
<td>23</td>
<td>23019</td>
<td>19ª Região Brejo Santo</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.00</td>
<td>...</td>
<td>35974.0</td>
<td>10496.0</td>
<td>3.427</td>
<td>58.043</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>POLYGON ((5433729.65 9186242.97, 5433688.546 9...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2300150.0</td>
<td>Acarape</td>
<td>CE</td>
<td>130.002</td>
<td>23</td>
<td>23003</td>
<td>3ª Região Maracanaú</td>
<td>6.380399</td>
<td>0.0</td>
<td>0.00</td>
<td>...</td>
<td>68314.0</td>
<td>15338.0</td>
<td>4.454</td>
<td>117.983</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
<td>POLYGON ((5476916.288 9533405.667, 5476798.561...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2300200.0</td>
<td>Acaraú</td>
<td>CE</td>
<td>842.471</td>
<td>23</td>
<td>23012</td>
<td>12ª Região Acaraú</td>
<td>0.000000</td>
<td>0.0</td>
<td>1.63</td>
<td>...</td>
<td>309490.0</td>
<td>57551.0</td>
<td>5.378</td>
<td>68.312</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>POLYGON ((5294389.783 9689469.144, 5294494.499...</td>
</tr>
</tbody>
</table>

<p>3 rows × 36 columns</p>
</div>
</div>
</div>
<div id="22717139" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the full set of variables</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(dfs.columns))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['code7', 'mun_name', 'state_init', 'area_km2', 'state_code', 'micro_code', 'micro_name', 'inc_mic_4q', 'inc_zik_3q', 'inc_zik_2q', 'inc_zik_1q', 'prim_care', 'ln_gdp', 'ln_pop', 'mobility', 'environ', 'housing', 'sanitation', 'infra', 'acu_zik_1q', 'acu_zik_2q', 'acu_zik_3q', 'pop_zikv', 'acu_mic_4q', 'pop_micro', 'lngdpcap', 'gdp', 'pop', 'gdpcap', 'popdens', 'zik_1q', 'ziq_2q', 'ziq_3q', 'zika_d', 'mic_d', 'geometry']</code></pre>
</div>
</div>
</section>
<section id="variables" class="level3" data-number="13.1.3">
<h3 data-number="13.1.3" class="anchored" data-anchor-id="variables"><span class="header-section-number">13.1.3</span> Variables</h3>
<p>We continue to use the same set of variables to replicate the empirical illustration in Chapter 11 of the <em>GeoDa Cluster Book</em>, as listed in <a href="hierarchical_spatial_clustering.html#tbl-spatialcluster-vars" class="quarto-xref">Table&nbsp;<span>12.1</span></a>. As before, we specify the variables in the <code>varlist</code> list for later use.</p>
<div id="8de6dec5" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>varlist <span class="op">=</span> [<span class="st">'mobility'</span>, <span class="st">'environ'</span>, <span class="st">'housing'</span>, <span class="st">'sanitation'</span>, <span class="st">'infra'</span>, <span class="st">'gdpcap'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pygeoda-data-preparation" class="level3" data-number="13.1.4">
<h3 data-number="13.1.4" class="anchored" data-anchor-id="pygeoda-data-preparation"><span class="header-section-number">13.1.4</span> Pygeoda Data Preparation</h3>
<p>We follow the same steps as in <a href="hierarchical_spatial_clustering.html" class="quarto-xref">Chapter&nbsp;<span>12</span></a> to set up a data set in the <code>pygeoda</code> internal format as <code>ceara_g</code> and to create queen contiguity spatial weights (<code>queen_w</code>).</p>
<div id="ffbb7a31" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ceara_g <span class="op">=</span> pygeoda.<span class="bu">open</span>(dfs)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>queen_w <span class="op">=</span> pygeoda.queen_weights(ceara_g)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>queen_w</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>Weights Meta-data:
 number of observations:                  184
           is symmetric:                 True
               sparsity:  0.02953686200378072
        # min neighbors:                    1
        # max neighbors:                   13
       # mean neighbors:    5.434782608695652
     # median neighbors:                  5.0
           has isolates:                False</code></pre>
</div>
</div>
<p>As in the previous Chapter, we create subsets with the relevant variables in both the <code>pygeoda</code> format (<code>data_g</code>) and as a GeoDataFrame (<code>data</code>).</p>
<div id="86db5242" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>data_g <span class="op">=</span> ceara_g[varlist]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> dfs[varlist]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We set the number of clusters to 12.</p>
<div id="61ff2371" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>n_clusters <span class="op">=</span> <span class="dv">12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="azp" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="azp"><span class="header-section-number">13.2</span> AZP</h2>
<p>The first spatially constrained partitioning method we consider is AZP. It is contained in <code>pygeoda</code>, which uses the same underlying code as <code>GeoDa</code>, except for some technical implementations related to memory management. Even though these differences are very low-level, they can influence the way the heuristic proceeds, since it moves sequentially through alternative configurations. The order in which these sequences are considered matters, and slight differences in the memory allocation can produce different results.</p>
<p>As a consequence, it is not possible to completely replicate the results from Chapter 11 in the <em>GeoDa Cluster Book</em>, given the differences between the low-level implementations in C++ and in Python. This is a general feature of any heuristic, where not only the algorithms matter, but also seemingly unrelated issues such as starting points, random numbers and the particular ordering of moves.</p>
<p>AZP is implemented as three different functions, corresponding to the <em>greedy</em>, <em>tabu</em> and <em>simulated annealing</em> optimization approaches (see Chapter 11 in the <em>GeoDa Cluster Book</em> for technical details). The matching functions are <code>azp_greedy</code>, <code>azp_tabu</code>, and <code>azp_sa</code>. Required arguments are the number of clusters, the spatial weights and the <code>pygeoda</code> data object.</p>
<section id="azp-greedy" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="azp-greedy"><span class="header-section-number">13.2.1</span> AZP-Greedy</h3>
<p>The first example uses greedy search, implemented in <code>azp_greedy</code>. We use the same approach as in the previous Chapter and employ the helper functions <code>cluster_stats</code>, <code>cluster_fit</code>, <code>cluster_center</code> and <code>cluster_map</code> to list the properties of the clusters (see <a href="hierarchical_spatial_clustering.html" class="quarto-xref">Chapter&nbsp;<span>12</span></a> for technical details).</p>
<div id="37d0a2a6" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>ceara_clusters1 <span class="op">=</span> pygeoda.azp_greedy(n_clusters, queen_w, data_g)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>tazp1 <span class="op">=</span> t1 <span class="op">-</span> t0</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AZP Greedy Clustering Time: "</span>, tazp1)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>cluster_labels1 <span class="op">=</span> np.array(ceara_clusters1[<span class="st">'Clusters'</span>])</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>c_stats <span class="op">=</span> cluster_stats(cluster_labels1)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> cluster_fit(data, cluster_labels1, n_clusters,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                  correct <span class="op">=</span> <span class="va">True</span>, printopt <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>clust_means, clust_medians <span class="op">=</span> cluster_center(data, cluster_labels1)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Means:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_means, <span class="dv">3</span>))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cluster Medians:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_medians, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AZP Greedy Clustering Time:  0.03095412254333496
 Labels  Cardinality
      1           46
      2           37
      3           29
      4           25
      5           21
      6            7
      7            5
      8            5
      9            4
     10            2
     11            2
     12            1

Total Sum of Squares (TSS): 1098.0
Within-cluster Sum of Squares (WSS) for each cluster: [124.036 115.162 139.302  71.455 105.922  16.194  16.279  26.967  53.98
   2.921  16.99    0.   ]
Total Within-cluster Sum of Squares (WSS): 689.208
Between-cluster Sum of Squares (BSS): 408.792
Ratio of BSS to TSS: 0.372
Cluster Means:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.965    0.883    0.852       0.686  0.552   4.524
2           0.959    0.864    0.800       0.603  0.513   4.490
3           0.946    0.814    0.798       0.592  0.469   6.265
4           0.960    0.883    0.852       0.629  0.528   4.591
5           0.960    0.797    0.826       0.646  0.512   4.679
6           0.942    0.924    0.846       0.573  0.391   5.208
7           0.982    0.939    0.839       0.833  0.612   5.691
8           0.833    0.750    0.800       0.743  0.537  11.102
9           0.944    0.897    0.841       0.593  0.405  16.482
10          0.960    0.930    0.900       0.641  0.424   4.170
11          0.974    0.657    0.781       0.823  0.693   5.432
12          0.936    0.789    0.794       0.545  0.425  27.625

Cluster Medians:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.968    0.888    0.849       0.677  0.560   4.220
2           0.959    0.885    0.801       0.581  0.505   4.140
3           0.948    0.824    0.807       0.573  0.470   4.742
4           0.968    0.896    0.851       0.602  0.534   4.395
5           0.963    0.805    0.831       0.636  0.514   4.140
6           0.935    0.943    0.842       0.575  0.377   5.114
7           0.983    0.932    0.829       0.798  0.606   4.099
8           0.834    0.741    0.823       0.784  0.561   7.982
9           0.957    0.882    0.846       0.590  0.419   9.262
10          0.960    0.930    0.900       0.641  0.424   4.170
11          0.974    0.657    0.781       0.823  0.693   5.432
12          0.936    0.789    0.794       0.545  0.425  27.625</code></pre>
</div>
</div>
<div id="cell-fig-azp-greedy" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the clusters</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, cluster_labels1, figsize <span class="op">=</span> (<span class="dv">4</span>, <span class="dv">4</span>), </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="st">""</span>, cmap <span class="op">=</span> <span class="st">'tab20'</span>,legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-azp-greedy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-azp-greedy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-azp-greedy-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-azp-greedy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.1: AZP Greedy cluster map
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="azp-tabu" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="azp-tabu"><span class="header-section-number">13.2.2</span> AZP-Tabu</h3>
<p>The Tabu algorithm for AZP is invoked with <code>azp_tabu</code>. In addition to the same arguments as for the basic AZP function, a <code>tabu_length</code> is required (the size of the tabu list of observations for which a swap is not possible), as well as the maximum number of non-improving moves, <code>conv_tabu</code>. In our illustration, these are set to respectively 50 and 25, as in Chapter 11 of the <em>GeoDa Cluster Book</em>. We use the same set of commands as before.</p>
<div id="d5cd3d03" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ceara_clusters2 <span class="op">=</span> pygeoda.azp_tabu(n_clusters, queen_w, data_g,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                   tabu_length <span class="op">=</span> <span class="dv">50</span>, conv_tabu <span class="op">=</span> <span class="dv">25</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>tazp2 <span class="op">=</span> t1 <span class="op">-</span> t0</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AZP Tabu Clustering Time: "</span>, tazp2)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>cluster_labels2 <span class="op">=</span> np.array(ceara_clusters2[<span class="st">'Clusters'</span>])</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>c_stats <span class="op">=</span> cluster_stats(cluster_labels2)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> cluster_fit(data, cluster_labels2, n_clusters,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                  correct <span class="op">=</span> <span class="va">True</span>, printopt <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>clust_means, clust_medians <span class="op">=</span> cluster_center(data, cluster_labels2)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Means:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_means, <span class="dv">3</span>))</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cluster Medians:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_medians, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AZP Tabu Clustering Time:  0.36464381217956543
 Labels  Cardinality
      1           50
      2           41
      3           26
      4           25
      5           14
      6           10
      7            5
      8            4
      9            4
     10            2
     11            2
     12            1

Total Sum of Squares (TSS): 1098.0
Within-cluster Sum of Squares (WSS) for each cluster: [155.14  119.919  97.683  71.455  78.79   34.08   16.279  53.98   11.088
   2.921  16.99    0.   ]
Total Within-cluster Sum of Squares (WSS): 658.326
Between-cluster Sum of Squares (BSS): 439.674
Ratio of BSS to TSS: 0.4
Cluster Means:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.959    0.860    0.803       0.608  0.502   4.575
2           0.968    0.904    0.849       0.693  0.538   4.533
3           0.956    0.780    0.835       0.644  0.542   4.636
4           0.960    0.883    0.852       0.629  0.528   4.591
5           0.922    0.759    0.779       0.580  0.465   6.315
6           0.947    0.909    0.834       0.550  0.409   7.222
7           0.982    0.939    0.839       0.833  0.612   5.691
8           0.944    0.897    0.841       0.593  0.405  16.482
9           0.833    0.766    0.818       0.792  0.574  12.600
10          0.960    0.930    0.900       0.641  0.424   4.170
11          0.974    0.657    0.781       0.823  0.693   5.432
12          0.936    0.789    0.794       0.545  0.425  27.625

Cluster Medians:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.957    0.878    0.808       0.581  0.495   4.322
2           0.970    0.902    0.844       0.680  0.542   4.242
3           0.960    0.774    0.838       0.630  0.564   4.134
4           0.968    0.896    0.851       0.602  0.534   4.395
5           0.933    0.763    0.785       0.581  0.458   4.802
6           0.949    0.911    0.836       0.535  0.382   5.281
7           0.983    0.932    0.829       0.798  0.606   4.099
8           0.957    0.882    0.846       0.590  0.419   9.262
9           0.835    0.766    0.824       0.799  0.583  11.557
10          0.960    0.930    0.900       0.641  0.424   4.170
11          0.974    0.657    0.781       0.823  0.693   5.432
12          0.936    0.789    0.794       0.545  0.425  27.625</code></pre>
</div>
</div>
<div id="cell-fig-azp-tabu" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the clusters</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, cluster_labels2, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>), </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="st">""</span>, cmap <span class="op">=</span> <span class="st">'tab20'</span>,legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-azp-tabu" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-azp-tabu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-azp-tabu-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-azp-tabu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.2: AZP Tabu cluster map
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="azp-simulated-annealing" class="level3" data-number="13.2.3">
<h3 data-number="13.2.3" class="anchored" data-anchor-id="azp-simulated-annealing"><span class="header-section-number">13.2.3</span> AZP-Simulated Annealing</h3>
<p>The simulated annealing algorithm for AZP is invoked with <code>azp_sa</code>. In addition to the same arguments as for the basic AZP function, a <code>cooling_rate</code> is required (the rate at which the simulated annealing temperature is allowed to decrease), as well as the maximum number of iterations allowed for each swap, <code>sa_maxit</code>. In our illustration, these are set to, respectively, 0.8 and 5. We use the same set of functions as before.</p>
<p>Note that the results differ slightly from the ones reported in Chapter 11 of the <em>GeoDa Cluster Book</em> even though the parameters are the same.</p>
<div id="5e95fd17" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>ceara_clusters3 <span class="op">=</span> pygeoda.azp_sa(n_clusters, queen_w, data_g,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                                   cooling_rate <span class="op">=</span> <span class="fl">0.8</span>, sa_maxit <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>tazp3 <span class="op">=</span> t1 <span class="op">-</span> t0</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AZP SA Clustering Time: "</span>, tazp3)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>cluster_labels3 <span class="op">=</span> np.array(ceara_clusters3[<span class="st">'Clusters'</span>])</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>c_stats <span class="op">=</span> cluster_stats(cluster_labels3)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> cluster_fit(data, cluster_labels3, n_clusters, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                  correct <span class="op">=</span> <span class="va">True</span>, printopt <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>clust_means, clust_medians <span class="op">=</span> cluster_center(data, cluster_labels3)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Means:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_means, <span class="dv">3</span>))</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cluster Medians:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_medians, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AZP SA Clustering Time:  3.248257637023926
 Labels  Cardinality
      1           71
      2           33
      3           28
      4           19
      5           12
      6            5
      7            5
      8            4
      9            2
     10            2
     11            2
     12            1

Total Sum of Squares (TSS): 1098.0
Within-cluster Sum of Squares (WSS) for each cluster: [204.08  101.845 129.825  50.521  41.189   7.637  26.967  53.98    2.921
   1.109  16.99    0.   ]
Total Within-cluster Sum of Squares (WSS): 637.065
Between-cluster Sum of Squares (BSS): 460.935
Ratio of BSS to TSS: 0.42
Cluster Means:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.965    0.903    0.847       0.674  0.533   4.621
2           0.958    0.860    0.795       0.586  0.505   4.473
3           0.938    0.816    0.802       0.565  0.453   6.141
4           0.953    0.732    0.834       0.615  0.545   4.734
5           0.981    0.879    0.848       0.748  0.594   5.154
6           0.974    0.896    0.831       0.746  0.452   5.363
7           0.833    0.750    0.800       0.743  0.537  11.102
8           0.944    0.897    0.841       0.593  0.405  16.482
9           0.960    0.930    0.900       0.641  0.424   4.170
10          0.917    0.921    0.829       0.562  0.369   3.810
11          0.974    0.657    0.781       0.823  0.693   5.432
12          0.936    0.789    0.794       0.545  0.425  27.625

Cluster Medians:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.968    0.905    0.846       0.671  0.526   4.319
2           0.959    0.883    0.800       0.571  0.498   4.140
3           0.940    0.811    0.808       0.567  0.464   4.738
4           0.958    0.720    0.833       0.608  0.563   4.140
5           0.984    0.909    0.851       0.752  0.584   4.234
6           0.983    0.906    0.836       0.775  0.409   4.985
7           0.834    0.741    0.823       0.784  0.561   7.982
8           0.957    0.882    0.846       0.590  0.419   9.262
9           0.960    0.930    0.900       0.641  0.424   4.170
10          0.917    0.921    0.829       0.562  0.369   3.810
11          0.974    0.657    0.781       0.823  0.693   5.432
12          0.936    0.789    0.794       0.545  0.425  27.625</code></pre>
</div>
</div>
<div id="cell-fig-azp-sa" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the clusters</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, cluster_labels3, figsize <span class="op">=</span> (<span class="dv">4</span>, <span class="dv">4</span>), </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="st">""</span>, cmap <span class="op">=</span> <span class="st">'tab20'</span>,legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-azp-sa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-azp-sa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-azp-sa-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-azp-sa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.3: AZP Simulated Annealing cluster map
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="arisel" class="level3" data-number="13.2.4">
<h3 data-number="13.2.4" class="anchored" data-anchor-id="arisel"><span class="header-section-number">13.2.4</span> ARiSel</h3>
<p>As in K-means, an alternative to a random initial feasible solution is to use a k-means++ like logic. This is implemented in the ARiSel approach, through the additional <code>inits</code> argument to any azp function. In the example below, we set <code>inits = 50</code>. We use <code>azp_sa</code> with a <code>cooling_rate</code> of 0.8 and <code>sa_maxit</code> as 5.</p>
<div id="40aff54b" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ceara_clusters4 <span class="op">=</span> pygeoda.azp_sa(n_clusters, queen_w, data_g, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                            cooling_rate <span class="op">=</span> <span class="fl">0.8</span>, sa_maxit <span class="op">=</span> <span class="dv">5</span>, inits <span class="op">=</span> <span class="dv">50</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>tazp4 <span class="op">=</span> t1 <span class="op">-</span> t0</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AZP ARiSel Clustering Time: "</span>, tazp4)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>cluster_labels4 <span class="op">=</span> np.array(ceara_clusters4[<span class="st">'Clusters'</span>])</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>c_stats <span class="op">=</span> cluster_stats(cluster_labels4)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> cluster_fit(data, cluster_labels4, n_clusters,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                  correct <span class="op">=</span> <span class="va">True</span>, printopt <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>clust_means, clust_medians <span class="op">=</span> cluster_center(data, cluster_labels4)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Means:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_means, <span class="dv">3</span>))</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cluster Medians:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_medians, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AZP ARiSel Clustering Time:  5.351151943206787
 Labels  Cardinality
      1           67
      2           29
      3           19
      4           19
      5           14
      6           13
      7            6
      8            6
      9            5
     10            4
     11            1
     12            1

Total Sum of Squares (TSS): 1098.0
Within-cluster Sum of Squares (WSS) for each cluster: [224.399  88.688  50.521  51.732  48.429  44.554  39.958   8.893  16.279
  11.088   0.      0.   ]
Total Within-cluster Sum of Squares (WSS): 584.54
Between-cluster Sum of Squares (BSS): 513.46
Ratio of BSS to TSS: 0.468
Cluster Means:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.968    0.888    0.844       0.692  0.552   4.663
2           0.954    0.858    0.795       0.586  0.510   4.513
3           0.953    0.732    0.834       0.615  0.545   4.734
4           0.956    0.897    0.855       0.604  0.480   4.272
5           0.960    0.821    0.806       0.644  0.464   4.450
6           0.944    0.883    0.842       0.574  0.416   7.300
7           0.902    0.772    0.748       0.615  0.447   8.392
8           0.939    0.834    0.783       0.486  0.454   5.613
9           0.982    0.939    0.839       0.833  0.612   5.691
10          0.833    0.766    0.818       0.792  0.574  12.600
11          0.957    0.966    0.857       0.593  0.357  40.018
12          0.936    0.789    0.794       0.545  0.425  27.625

Cluster Medians:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.970    0.898    0.845       0.678  0.551   4.390
2           0.952    0.883    0.792       0.564  0.498   4.183
3           0.958    0.720    0.833       0.608  0.563   4.140
4           0.964    0.896    0.851       0.585  0.491   4.097
5           0.959    0.835    0.812       0.618  0.469   4.355
6           0.951    0.896    0.836       0.579  0.424   6.171
7           0.905    0.779    0.750       0.605  0.444   5.140
8           0.939    0.840    0.790       0.494  0.468   4.802
9           0.983    0.932    0.829       0.798  0.606   4.099
10          0.835    0.766    0.824       0.799  0.583  11.557
11          0.957    0.966    0.857       0.593  0.357  40.018
12          0.936    0.789    0.794       0.545  0.425  27.625</code></pre>
</div>
</div>
<div id="cell-fig-azp-arisel" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, cluster_labels4, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>), </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="st">""</span>, cmap <span class="op">=</span> <span class="st">'tab20'</span>,legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-azp-arisel" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-azp-arisel-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-azp-arisel-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-azp-arisel-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.4: AZP ARiSel cluster map
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="azp-with-initial-clustering-result" class="level3" data-number="13.2.5">
<h3 data-number="13.2.5" class="anchored" data-anchor-id="azp-with-initial-clustering-result"><span class="header-section-number">13.2.5</span> AZP with Initial Clustering Result</h3>
<p>As mentioned in the discussion of hierarchical spatially constrained solutions in <a href="hierarchical_spatial_clustering.html" class="quarto-xref">Chapter&nbsp;<span>12</span></a>, one of the drawbacks of those methods is that observations tend to be <em>trapped</em> in a branch of the dendrogram or minimum spanning tree. Since AZP implements swapping of observations, we can use the endpoint of one of the hierarchical methods as the feasible initial solution for AZP. In many instances (but not all), this improves on the hierarchical solution and sometimes also obtains better solutions than straight AZP.</p>
<p>In all these illustrations, it is important to keep in mind the sensitivity of the results to the various tuning parameters (which are under the analyst’s control) as well as hardware implementations (which are not).</p>
<p>We illustrate this approach by using the end solution of SCHC as the initial solution for AZP, set by means of the <code>init_regions</code> argument.</p>
<div id="c063f192" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ceara_clusters <span class="op">=</span> pygeoda.schc(n_clusters, queen_w, data_g, <span class="st">"ward"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>schc_cluster_labels <span class="op">=</span> ceara_clusters[<span class="st">'Clusters'</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>ceara_clusters5 <span class="op">=</span> pygeoda.azp_sa(n_clusters, queen_w, data_g, </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                                cooling_rate <span class="op">=</span> <span class="fl">0.8</span>, sa_maxit <span class="op">=</span> <span class="dv">5</span>, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                                init_regions <span class="op">=</span> schc_cluster_labels)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>tazp5 <span class="op">=</span> t1 <span class="op">-</span> t0 </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AZP-SCHC Clustering Time: "</span>, tazp5)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>cluster_labels5 <span class="op">=</span> np.array(ceara_clusters5[<span class="st">'Clusters'</span>])</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>c_stats <span class="op">=</span> cluster_stats(cluster_labels5)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> cluster_fit(data, cluster_labels5, n_clusters,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>                  correct <span class="op">=</span> <span class="va">True</span>, printopt <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>clust_means, clust_medians <span class="op">=</span> cluster_center(data, cluster_labels5)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Means:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_means, <span class="dv">3</span>))</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cluster Medians:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_medians, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AZP-SCHC Clustering Time:  3.6895642280578613
 Labels  Cardinality
      1           88
      2           43
      3           15
      4           14
      5            8
      6            4
      7            4
      8            3
      9            2
     10            1
     11            1
     12            1

Total Sum of Squares (TSS): 1098.0
Within-cluster Sum of Squares (WSS) for each cluster: [246.863 134.79   30.167  49.716  31.033  14.614  11.088   5.956  16.99
   0.      0.      0.   ]
Total Within-cluster Sum of Squares (WSS): 541.218
Between-cluster Sum of Squares (BSS): 556.782
Ratio of BSS to TSS: 0.507
Cluster Means:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.964    0.895    0.847       0.670  0.526   4.600
2           0.950    0.836    0.790       0.578  0.494   4.460
3           0.952    0.719    0.842       0.625  0.575   4.887
4           0.944    0.883    0.837       0.563  0.414   7.450
5           0.984    0.896    0.845       0.786  0.613   5.042
6           0.968    0.835    0.784       0.578  0.413   4.327
7           0.833    0.766    0.818       0.792  0.574  12.600
8           0.874    0.711    0.742       0.612  0.420   5.307
9           0.974    0.657    0.781       0.823  0.693   5.432
10          0.957    0.966    0.857       0.593  0.357  40.018
11          0.936    0.789    0.794       0.545  0.425  27.625
12          0.951    0.824    0.771       0.573  0.443  25.464

Cluster Medians:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.968    0.896    0.846       0.669  0.523   4.380
2           0.950    0.859    0.791       0.562  0.490   4.229
3           0.950    0.709    0.845       0.608  0.569   3.923
4           0.949    0.889    0.836       0.577  0.419   6.778
5           0.986    0.924    0.844       0.798  0.616   3.992
6           0.966    0.829    0.784       0.604  0.439   4.299
7           0.835    0.766    0.824       0.799  0.583  11.557
8           0.885    0.687    0.730       0.622  0.427   5.110
9           0.974    0.657    0.781       0.823  0.693   5.432
10          0.957    0.966    0.857       0.593  0.357  40.018
11          0.936    0.789    0.794       0.545  0.425  27.625
12          0.951    0.824    0.771       0.573  0.443  25.464</code></pre>
</div>
</div>
<div id="cell-fig-azp-schc" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, cluster_labels5, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>), </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="st">""</span>, cmap <span class="op">=</span> <span class="st">'tab20'</span>,legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-azp-schc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-azp-schc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-azp-schc-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-azp-schc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.5: AZP with SCHC initialization
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="comparing-azp-implementations" class="level3" data-number="13.2.6">
<h3 data-number="13.2.6" class="anchored" data-anchor-id="comparing-azp-implementations"><span class="header-section-number">13.2.6</span> Comparing AZP Implementations</h3>
<p>To close the discussion of AZP, we provide a brief summary of the spatial layout and measure of fit for the greedy algorithm, the tabu search, and two simulated annealing results, one with 50 initial re-runs and one using SCHC as the starting point. The latter solution clearly achieves the highest BSS/TSS ratio.</p>
<div id="cell-fig-azp-comparisons" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparing the results, except the basic AZP (SA) </span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> [<span class="st">"AZP (Greedy)"</span>, <span class="st">"AZP (Tabu Search)"</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"AZP (SA) (50 re-runs)"</span>, <span class="st">"AZP (SA) (SCHC initial regions)"</span>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, [cluster_labels1, cluster_labels2, cluster_labels4, </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>            cluster_labels5], </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> titles, cmap <span class="op">=</span> <span class="st">'tab20'</span>, </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>            grid_shape <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">2</span>), figsize <span class="op">=</span> (<span class="dv">8</span>, <span class="dv">8</span>),legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-azp-comparisons" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-azp-comparisons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-azp-comparisons-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-azp-comparisons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.6: AZP solutions
</figcaption>
</figure>
</div>
</div>
</div>
<div id="43aa7b0f" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>ceara_clusters <span class="op">=</span> [ceara_clusters1, ceara_clusters2, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                  ceara_clusters4, ceara_clusters5]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The ratio of between to total sum of squares:"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, cluster <span class="kw">in</span> <span class="bu">enumerate</span>(ceara_clusters):</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(titles[i],</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f": </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">round</span>(cluster[<span class="st">'The ratio of between to total sum of squares'</span>], </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">4</span>)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The ratio of between to total sum of squares:
AZP (Greedy) : 0.3723
AZP (Tabu Search) : 0.4004
AZP (SA) (50 re-runs) : 0.4676
AZP (SA) (SCHC initial regions) : 0.5071</code></pre>
</div>
</div>
</section>
</section>
<section id="max-p-regions" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="max-p-regions"><span class="header-section-number">13.3</span> Max-p Regions</h2>
<p>Up to this point, we had to specify the number of clusters beforehand as the first argument to be passed to the <code>pygeoda</code> clustering routines. The max-p approach takes a different perspective. It attempts to find the largest number of clusters possible (the <em>max p</em>) within a given constraint on the cluster size. Without such a constraint, the solution would always equal the number of observations.</p>
<p>The minimum cluster size, or <code>min_bound</code> is typically a function of the total for a <em>spatially extensive</em> variable, like population or total number of housing units. However, it can be set differently as well. Keep in mind that the larger the minimum bound, the smaller the number of clusters that will be found, and the other way around. When the minimum size is not determined by some fixed policy criterion, it may therefore be good to do some experimentation.</p>
<p>The max-p algorithm is essentially AZP applied to an initial feasible solution that follows a heuristic to maximize the number of regions that satisfy the minimum bounds constraint. As before, several random starting points should be explored as the results are quite sensitive to this initial solution.</p>
<p>We illustrate max-p for the Ceará example using simulated annealing with the <code>min_bound</code> set to a percentage of the total population. As for AZP, three functions are available, <code>maxp_greedy</code>, <code>maxp_tabu</code> and <code>maxp_sa</code>. The AZP-related arguments are the same as for the core AZP functions. The <code>n_clusters</code> argument is (obviously) no longer needed. Instead, the <code>bound_variable</code> defines the spatially extensive variable for the minimum constraint, and <code>min_bound</code> sets its actual value. Here, we take <code>'pop'</code> as the variable (from the geodataframe), and compute the percentage for the bound using <code>sum()</code> multiplied by a fraction.</p>
<p>In the first example, we use <code>maxp_greedy</code> with a population minimum of 10% of the total, or 845,238. This yields a solution with 6 clusters, achieving a miserable BSS/TSS of 0.26.</p>
<div id="309493f9" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ceara_clusters6 <span class="op">=</span> pygeoda.maxp_greedy(queen_w, data_g, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                                      bound_variable <span class="op">=</span> dfs[<span class="st">'pop'</span>], </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                                      min_bound <span class="op">=</span> dfs[<span class="st">'pop'</span>].<span class="bu">sum</span>()<span class="op">*</span><span class="fl">0.1</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>tmaxp1 <span class="op">=</span> t1 <span class="op">-</span> t0</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Max-p (10%) Clustering Time: "</span>, tmaxp1)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>cluster_labels6 <span class="op">=</span> np.array(ceara_clusters6[<span class="st">'Clusters'</span>])</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>c_stats <span class="op">=</span> cluster_stats(cluster_labels6)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> cluster_fit(data, cluster_labels6, n_clusters,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>                  correct <span class="op">=</span> <span class="va">True</span>, printopt <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>clust_means, clust_medians <span class="op">=</span> cluster_center(data, cluster_labels6)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Means:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_means, <span class="dv">3</span>))</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cluster Medians:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_medians, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Max-p (10%) Clustering Time:  0.12100005149841309
 Labels  Cardinality
      1           64
      2           45
      3           35
      4           30
      5            8
      6            2

Total Sum of Squares (TSS): 1098.0
Within-cluster Sum of Squares (WSS) for each cluster: [283.714 150.575 190.247 103.556  69.006  15.465]
Total Within-cluster Sum of Squares (WSS): 812.563
Between-cluster Sum of Squares (BSS): 285.437
Ratio of BSS to TSS: 0.26
Cluster Means:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.964    0.847    0.841       0.673  0.545   4.521
2           0.951    0.844    0.792       0.577  0.494   5.009
3           0.951    0.892    0.850       0.644  0.456   6.236
4           0.974    0.878    0.841       0.657  0.554   4.818
5           0.871    0.759    0.777       0.682  0.490  10.228
6           0.891    0.806    0.809       0.680  0.515  21.378

Cluster Medians:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.965    0.875    0.843       0.661  0.556   4.202
2           0.950    0.862    0.793       0.562  0.490   4.386
3           0.957    0.896    0.850       0.613  0.452   4.985
4           0.978    0.893    0.849       0.620  0.550   4.436
5           0.866    0.750    0.777       0.680  0.471   7.154
6           0.891    0.806    0.809       0.680  0.515  21.378</code></pre>
</div>
</div>
<div id="cell-fig-maxp-10" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, cluster_labels6, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>), </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="st">""</span>, cmap <span class="op">=</span> <span class="st">'tab20'</span>,legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-maxp-10" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-maxp-10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-maxp-10-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-maxp-10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.7: Max-p with 10% population bound
</figcaption>
</figure>
</div>
</div>
</div>
<section id="sensitivity-analysis" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="sensitivity-analysis"><span class="header-section-number">13.3.1</span> Sensitivity Analysis</h3>
<p>The importance of sensitivity analysis for max-p cannot be understated. To illustrate the different outcomes that can be obtained by tuning the various parameters, we give two examples using simulated annealing with a minimum bound of 5% and 3% respectively.</p>
<p>We first consider 5%, i.e., a population minimum of 422,619. We set the number of iterations (<code>iterations</code>) to 9999, use a cooling rate of 0.9 and <code>maxit</code> of 5. Note that this achieves a p of 13, compared to 12 in Figure 11.28 for <code>GeoDa</code>, but the BSS/TSS ratio is 0.321, relative to 0.385 in <code>GeoDa</code>.</p>
<div id="b2f53559" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>ceara_clusters7 <span class="op">=</span> pygeoda.maxp_sa(queen_w, data_g, </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                                      bound_variable <span class="op">=</span> dfs[<span class="st">'pop'</span>], </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                                      min_bound <span class="op">=</span> dfs[<span class="st">'pop'</span>].<span class="bu">sum</span>()<span class="op">*</span><span class="fl">0.05</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                                      iterations <span class="op">=</span> <span class="dv">9999</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                                      cooling_rate <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                                      sa_maxit <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()    </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>tmaxp2 <span class="op">=</span> t1 <span class="op">-</span> t0</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Max-p (5%) Clustering Time: "</span>, tmaxp2)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>cluster_labels7 <span class="op">=</span> np.array(ceara_clusters7[<span class="st">'Clusters'</span>])</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>c_stats <span class="op">=</span> cluster_stats(cluster_labels7)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> cluster_fit(data, cluster_labels7, n_clusters,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>                  correct <span class="op">=</span> <span class="va">True</span>, printopt <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>clust_means, clust_medians <span class="op">=</span> cluster_center(data, cluster_labels7)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Means:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_means, <span class="dv">3</span>))</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cluster Medians:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_medians, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Max-p (5%) Clustering Time:  7.94816780090332
 Labels  Cardinality
      1           24
      2           23
      3           20
      4           19
      5           18
      6           18
      7           17
      8           14
      9           11
     10            8
     11            7
     12            3
     13            2

Total Sum of Squares (TSS): 1098.0
Within-cluster Sum of Squares (WSS) for each cluster: [ 74.807  83.702  32.777  95.473  65.341  69.935  44.14  103.769  42.53
  36.253  68.153  26.218   2.151]
Total Within-cluster Sum of Squares (WSS): 745.247
Between-cluster Sum of Squares (BSS): 352.753
Ratio of BSS to TSS: 0.321
Cluster Means:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.959    0.875    0.845       0.618  0.484   4.593
2           0.963    0.831    0.832       0.614  0.487   4.154
3           0.961    0.907    0.847       0.723  0.548   4.552
4           0.965    0.817    0.846       0.682  0.597   4.648
5           0.941    0.826    0.793       0.616  0.483   4.490
6           0.966    0.811    0.808       0.610  0.540   4.227
7           0.958    0.908    0.809       0.593  0.527   5.050
8           0.946    0.911    0.846       0.580  0.415   9.707
9           0.973    0.908    0.837       0.738  0.570   5.209
10          0.965    0.849    0.839       0.716  0.548   5.356
11          0.906    0.763    0.776       0.568  0.439  10.761
12          0.889    0.764    0.783       0.651  0.456  13.360
13          0.835    0.807    0.826       0.838  0.619  11.404

Cluster Medians:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.964    0.870    0.845       0.586  0.495   4.431
2           0.964    0.837    0.827       0.602  0.510   4.058
3           0.965    0.900    0.845       0.708  0.542   4.444
4           0.968    0.855    0.851       0.644  0.590   4.338
5           0.940    0.825    0.793       0.588  0.479   4.342
6           0.972    0.835    0.810       0.579  0.554   3.992
7           0.954    0.900    0.807       0.594  0.505   4.649
8           0.956    0.914    0.839       0.583  0.419   7.266
9           0.976    0.928    0.845       0.756  0.574   4.394
10          0.964    0.931    0.838       0.680  0.578   4.864
11          0.931    0.773    0.788       0.545  0.425   5.110
12          0.903    0.758    0.783       0.669  0.443   7.982
13          0.835    0.807    0.826       0.838  0.619  11.404</code></pre>
</div>
</div>
<div id="cell-fig-maxp-5" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, cluster_labels7, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>), </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="st">""</span>, cmap <span class="op">=</span> <span class="st">'tab20'</span>,legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-maxp-5" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-maxp-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-maxp-5-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-maxp-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.8: Max-p with 5% population bound
</figcaption>
</figure>
</div>
</div>
</div>
<p>In the final example, we set the population minimum to 3%, or 253,571, with the same SA parameters. This yields 19 clusters, with a BSS/TSS ratio of 0.436, similar to the solution obtained with <code>GeoDa</code> (0.439). This again highlights the importance of experimentation with the various parameters.</p>
<div id="72111841" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>ceara_clusters8 <span class="op">=</span> pygeoda.maxp_sa(queen_w, data_g, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                                      bound_variable <span class="op">=</span> dfs[<span class="st">'pop'</span>], </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                                      min_bound <span class="op">=</span> dfs[<span class="st">'pop'</span>].<span class="bu">sum</span>()<span class="op">*</span><span class="fl">0.03</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                                      iterations <span class="op">=</span> <span class="dv">9999</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                                      cooling_rate <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                                      sa_maxit <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>tmaxp3 <span class="op">=</span> t1 <span class="op">-</span> t0</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Max-p (3%) Clustering Time: "</span>, tmaxp3)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>cluster_labels8 <span class="op">=</span> np.array(ceara_clusters8[<span class="st">'Clusters'</span>])</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>c_stats <span class="op">=</span> cluster_stats(cluster_labels8)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>fit <span class="op">=</span> cluster_fit(data, cluster_labels8, n_clusters,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>                  correct <span class="op">=</span> <span class="va">True</span>, printopt <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>clust_means, clust_medians <span class="op">=</span> cluster_center(data, cluster_labels8)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cluster Means:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_means, <span class="dv">3</span>))</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cluster Medians:</span><span class="ch">\n</span><span class="st">"</span>, np.<span class="bu">round</span>(clust_medians, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Max-p (3%) Clustering Time:  10.129745960235596
 Labels  Cardinality
      1           33
      2           16
      3           14
      4           13
      5           12
      6           12
      7           12
      8           10
      9           10
     10           10
     11            8
     12            7
     13            7
     14            6
     15            5
     16            4
     17            2
     18            2
     19            1

Total Sum of Squares (TSS): 1098.0
Within-cluster Sum of Squares (WSS) for each cluster: [71.542 43.964 51.354 35.693 57.527 25.585 33.225 20.233 26.853 31.334
 15.088 84.027 28.591 39.958 16.279  6.894 15.465  5.476  0.   ]
Total Within-cluster Sum of Squares (WSS): 609.089
Between-cluster Sum of Squares (BSS): 488.911
Ratio of BSS to TSS: 0.445
Cluster Means:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.963    0.904    0.853       0.703  0.543   4.539
2           0.955    0.896    0.853       0.589  0.474   4.279
3           0.972    0.909    0.840       0.675  0.528   4.158
4           0.952    0.825    0.795       0.595  0.458   4.129
5           0.972    0.830    0.826       0.738  0.537   5.244
6           0.974    0.861    0.846       0.653  0.572   4.743
7           0.954    0.887    0.805       0.612  0.550   5.068
8           0.952    0.761    0.849       0.626  0.579   4.278
9           0.938    0.876    0.825       0.526  0.418   6.738
10          0.956    0.784    0.776       0.571  0.509   4.188
11          0.956    0.914    0.810       0.582  0.482   4.655
12          0.949    0.865    0.836       0.576  0.425  12.688
13          0.967    0.783    0.807       0.611  0.471   5.202
14          0.902    0.772    0.748       0.615  0.447   8.392
15          0.982    0.939    0.839       0.833  0.612   5.691
16          0.939    0.666    0.838       0.618  0.567   4.999
17          0.891    0.806    0.809       0.680  0.515  21.378
18          0.836    0.766    0.827       0.822  0.597  13.644
19          0.814    0.709    0.795       0.710  0.497   7.982

Cluster Medians:
          mobility  environ  housing  sanitation  infra  gdpcap
cluster                                                       
1           0.966    0.905    0.856       0.698  0.543   4.390
2           0.964    0.896    0.851       0.577  0.461   4.208
3           0.974    0.918    0.835       0.635  0.518   3.993
4           0.954    0.827    0.810       0.568  0.467   4.229
5           0.971    0.861    0.838       0.777  0.525   5.160
6           0.980    0.878    0.852       0.634  0.562   4.387
7           0.950    0.887    0.804       0.598  0.552   4.635
8           0.950    0.774    0.853       0.617  0.580   3.888
9           0.940    0.870    0.827       0.510  0.419   6.024
10          0.963    0.765    0.782       0.554  0.518   3.978
11          0.956    0.928    0.810       0.566  0.483   4.659
12          0.957    0.882    0.836       0.575  0.434   7.957
13          0.965    0.736    0.805       0.638  0.491   4.313
14          0.905    0.779    0.750       0.605  0.444   5.140
15          0.983    0.932    0.829       0.798  0.606   4.099
16          0.939    0.664    0.832       0.595  0.590   4.276
17          0.891    0.806    0.809       0.680  0.515  21.378
18          0.836    0.766    0.827       0.822  0.597  13.644
19          0.814    0.709    0.795       0.710  0.497   7.982</code></pre>
</div>
</div>
<div id="cell-fig-maxp-3" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>cluster_map(dfs, cluster_labels8, figsize <span class="op">=</span> (<span class="dv">5</span>, <span class="dv">5</span>), </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="st">""</span>, cmap <span class="op">=</span> <span class="st">'tab20'</span>,legend_fontsize<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-maxp-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-maxp-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="partitioned_spatial_clustering_files/figure-html/fig-maxp-3-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-maxp-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.9: Max-p with 3% population bound
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="practice" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="practice"><span class="header-section-number">13.4</span> Practice</h2>
<p>We can now use the max-p approach to compare the previous solutions with a pre-set number of clusters to what is obtained when this becomes a parameter to be optimized. In each instance, considerable sensitivity analysis is required.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Duqueetal12" class="csl-entry" role="listitem">
Duque, Juan C., Luc Anselin, and Sergio J. Rey. 2012. <span>“The Max-p-Regions Problem.”</span> <em>Journal of Regional Science</em> 52: 397–419.
</div>
<div id="ref-Openshaw77" class="csl-entry" role="listitem">
Openshaw, Stan. 1977. <span>“A Geographical Solution to Scale and Aggregation Problems in Region-Building, Partitioning and Spatial Modeling.”</span> <em>Transactions of the Institute of British Geographers</em> 2: 459–72.
</div>
<div id="ref-OpenshawRao95" class="csl-entry" role="listitem">
Openshaw, Stan, and L. Rao. 1995. <span>“Algorithms for Reengineering the 1991 Census Geography.”</span> <em>Environment and Planning A</em> 27: 425–46.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./hierarchical_spatial_clustering.html" class="pagination-link" aria-label="Spatially Constrained Clustering - Hierarchical Methods">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatially Constrained Clustering - Hierarchical Methods</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./cluster_validation.html" class="pagination-link" aria-label="Cluster Validation">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Cluster Validation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2025 GeoDa Press LLC, All Rights Reserved</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>