<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>14&nbsp; Cluster Validation – The Python Companion to Spatial Cluster Analysis with GeoDa</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./bibliography.html" rel="next">
<link href="./partitioned_spatial_clustering.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cluster_validation.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Cluster Validation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">The Python Companion to Spatial Cluster Analysis with GeoDa</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Creating_maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Creating Thematic Maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Multivariate_local.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Multivariate Local Spatial Clusters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Density_cluster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Density Based Clustering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PCA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Principal Component Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./MDS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Distance Preserving Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Hierarchical Clustering Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Partitioning Clustering Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kmedoids.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Clustering Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spectral_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spectral Clustering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatializing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Spatializing Classic Clustering Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical_spatial_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatially Constrained Clustering - Hierarchical Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./partitioned_spatial_clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Spatially Constrained Clustering - Partitioning Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cluster_validation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Cluster Validation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link active" data-scroll-target="#preliminaries"><span class="header-section-number">14.1</span> Preliminaries</a>
  <ul class="collapse">
  <li><a href="#load-required-packages" id="toc-load-required-packages" class="nav-link" data-scroll-target="#load-required-packages"><span class="header-section-number">14.1.1</span> Import Required Modules</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data"><span class="header-section-number">14.1.2</span> Load Data</a></li>
  <li><a href="#variables" id="toc-variables" class="nav-link" data-scroll-target="#variables"><span class="header-section-number">14.1.3</span> Variables</a></li>
  <li><a href="#pygeoda-data-preparation" id="toc-pygeoda-data-preparation" class="nav-link" data-scroll-target="#pygeoda-data-preparation"><span class="header-section-number">14.1.4</span> Pygeoda Data Preparation</a></li>
  </ul></li>
  <li><a href="#cluster-solutions" id="toc-cluster-solutions" class="nav-link" data-scroll-target="#cluster-solutions"><span class="header-section-number">14.2</span> Cluster Solutions</a>
  <ul class="collapse">
  <li><a href="#hierarchical-clustering" id="toc-hierarchical-clustering" class="nav-link" data-scroll-target="#hierarchical-clustering"><span class="header-section-number">14.2.1</span> Hierarchical Clustering</a></li>
  <li><a href="#k-means-clustering" id="toc-k-means-clustering" class="nav-link" data-scroll-target="#k-means-clustering"><span class="header-section-number">14.2.2</span> K-Means Clustering</a></li>
  <li><a href="#schc-with-wards-linkage" id="toc-schc-with-wards-linkage" class="nav-link" data-scroll-target="#schc-with-wards-linkage"><span class="header-section-number">14.2.3</span> SCHC with Ward’s Linkage</a></li>
  <li><a href="#skater" id="toc-skater" class="nav-link" data-scroll-target="#skater"><span class="header-section-number">14.2.4</span> SKATER</a></li>
  <li><a href="#redcap" id="toc-redcap" class="nav-link" data-scroll-target="#redcap"><span class="header-section-number">14.2.5</span> REDCAP</a></li>
  <li><a href="#azp-with-simulated-annealing" id="toc-azp-with-simulated-annealing" class="nav-link" data-scroll-target="#azp-with-simulated-annealing"><span class="header-section-number">14.2.6</span> AZP with Simulated Annealing</a></li>
  <li><a href="#azp-with-schc-as-initial-solution" id="toc-azp-with-schc-as-initial-solution" class="nav-link" data-scroll-target="#azp-with-schc-as-initial-solution"><span class="header-section-number">14.2.7</span> AZP with SCHC as Initial Solution</a></li>
  <li><a href="#max-p-regions" id="toc-max-p-regions" class="nav-link" data-scroll-target="#max-p-regions"><span class="header-section-number">14.2.8</span> Max-p Regions</a></li>
  </ul></li>
  <li><a href="#internal-validation-measures" id="toc-internal-validation-measures" class="nav-link" data-scroll-target="#internal-validation-measures"><span class="header-section-number">14.3</span> Internal Validation Measures</a>
  <ul class="collapse">
  <li><a href="#fragmentation" id="toc-fragmentation" class="nav-link" data-scroll-target="#fragmentation"><span class="header-section-number">14.3.1</span> Fragmentation</a></li>
  <li><a href="#join-count-ratio" id="toc-join-count-ratio" class="nav-link" data-scroll-target="#join-count-ratio"><span class="header-section-number">14.3.2</span> Join Count Ratio</a></li>
  <li><a href="#compactness" id="toc-compactness" class="nav-link" data-scroll-target="#compactness"><span class="header-section-number">14.3.3</span> Compactness</a></li>
  <li><a href="#diameter" id="toc-diameter" class="nav-link" data-scroll-target="#diameter"><span class="header-section-number">14.3.4</span> Diameter</a></li>
  <li><a href="#overall-comparison-of-internal-validation-measures" id="toc-overall-comparison-of-internal-validation-measures" class="nav-link" data-scroll-target="#overall-comparison-of-internal-validation-measures"><span class="header-section-number">14.3.5</span> Overall Comparison of Internal Validation Measures</a></li>
  </ul></li>
  <li><a href="#external-validation-measures" id="toc-external-validation-measures" class="nav-link" data-scroll-target="#external-validation-measures"><span class="header-section-number">14.4</span> External Validation Measures</a>
  <ul class="collapse">
  <li><a href="#adjusted-rand-index-ari" id="toc-adjusted-rand-index-ari" class="nav-link" data-scroll-target="#adjusted-rand-index-ari"><span class="header-section-number">14.4.1</span> Adjusted Rand Index (ARI)</a></li>
  <li><a href="#normalized-information-distance-nid" id="toc-normalized-information-distance-nid" class="nav-link" data-scroll-target="#normalized-information-distance-nid"><span class="header-section-number">14.4.2</span> Normalized Information Distance (NID)</a></li>
  </ul></li>
  <li><a href="#practice" id="toc-practice" class="nav-link" data-scroll-target="#practice"><span class="header-section-number">14.5</span> Practice</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Cluster Validation</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>To close this Companion Book, we consider cluster validation measures. These can be classified as <em>internal</em> validation measures, such as the measures of fit we already considered, as well as <em>external</em> validation measures, which provide a way to compare cluster solutions to a given (known, or assumed known) reference.</p>
<p>In addition to measures of fit, we also consider indicators of the <em>balance</em> of cluster solutions, i.e., the evenness of the number of observations in each cluster. Such measures include <em>entropy</em> and <em>Simpson’s index</em>. Other measures, introduced in the <em>GeoDa Cluster Book</em> are based on the <em>spatial</em> properties of the clusters. These include the <em>join count ratio</em>, an indicator of how many <em>neighbors</em> of each observation in a cluster are also members of the cluster. For a spatially compact cluster solution, this measure should equal one (except for boundary effects). For non spatially constrained clusters, it indicates how closely they approximate a spatial solution.</p>
<p>For spatially constrained cluster solutions, <em>compactness</em> is a key characteristic. This can be quantified by means of the <em>isoperimeter quotient (IPQ)</em>, the ratio of the area of a cluster shape to that of a circle with equal perimeter. A final measure of compactness introduced in the <em>GeoDa Cluster Book</em> is the <em>diameter</em> of the unweighted graph representation of the spatial weights matrix. To obtain a relative measure, the diameter is rescaled by the number of observations in the cluster. The latter measures are only applicable to spatially constrained clusters.</p>
<p>In addition, we also consider two classic indicators of external validity, i.e., the <em>Adjusted Rand Index (ARI)</em> of <span class="citation" data-cites="HubertArabie85">Hubert and Arabie (<a href="bibliography.html#ref-HubertArabie85" role="doc-biblioref">1985</a>)</span>, based on counting pairs, and the <em>Normalized Information Distance (NID)</em>, e.g., <span class="citation" data-cites="Vinhetal10">Vinh, Epps, and Bailey (<a href="bibliography.html#ref-Vinhetal10" role="doc-biblioref">2010</a>)</span>, derived from measures of entropy.</p>
<p>A detailed coverage of these methods is contained in Chapter 12 of the <em>GeoDa Cluster Book</em>.</p>
<p>In addition to the usual <code>numpy</code>, <code>pandas</code> and <code>geopandas</code>, we need several specialized packages from scikit-learn and <code>pygeoda</code> to carry out the cluster analysis and implement the validation measures. As before, to carry out variable standardization we import <code>StandardScaler</code> from <code>sklearn.preprocessing</code>. The specific clustering methods are <code>AgglomerativeClustering</code> and <code>KMeans</code> from <code>sklearn.cluster</code>. The other clustering solutions are obtained with <code>pygeoda</code>. The external validation measures are contained in <code>sklearn.metrics.adjusted_rand_score</code> and <code>sklearn.metrics.adjusted_mutual_info_score</code>.</p>
<p>The new internal validation measures are based on <code>pygeoda.spatial_validation</code>. Several helper functions contained in the <code>spatial-cluster-helper</code> module extract the relevant information and present it as a pandas data frame: <code>cluster_fragmentation</code>, <code>cluster_joincount</code>, <code>cluster_compactness</code> and <code>cluster_diameter</code>. As before, we also use <code>ensure_datasets</code>, <code>cluster_stats</code> and <code>cluster_fit</code>.</p>
<p>We continue the empirical illustration with the Ceará example.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Required Packages">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Required Packages
</div>
</div>
<div class="callout-body-container callout-body">
<p>numpy, pandas, geopandas, sklearn.cluster, sklearn.preprocessing, sklearn.metrics, spatial_cluster_helper, pygeoda</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Required Data Sets">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Required Data Sets
</div>
</div>
<div class="callout-body-container callout-body">
<p>ceara</p>
</div>
</div>
<section id="preliminaries" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="preliminaries"><span class="header-section-number">14.1</span> Preliminaries</h2>
<section id="load-required-packages" class="level3" data-number="14.1.1">
<h3 data-number="14.1.1" class="anchored" data-anchor-id="load-required-packages"><span class="header-section-number">14.1.1</span> Import Required Modules</h3>
<div id="e49b893f" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> AgglomerativeClustering, KMeans</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> adjusted_rand_score, adjusted_mutual_info_score</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spatial_cluster_helper <span class="im">import</span> ensure_datasets, cluster_stats, <span class="op">\</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>          cluster_fit, cluster_fragmentation, cluster_joincount, <span class="op">\</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>          cluster_compactness, cluster_diameter</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygeoda</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-data" class="level3" data-number="14.1.2">
<h3 data-number="14.1.2" class="anchored" data-anchor-id="load-data"><span class="header-section-number">14.1.2</span> Load Data</h3>
<p>We again read the <code>ceara.shp</code> file and carry out a quick check of the contens. For this sample data, we use the argument <code>encoding = 'utf-8'</code> in the <code>read_file</code> function to account for the special characters in Brazilian Portuguese.</p>
<div id="a2bd865b" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting working folder:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#path = "/your/path/to/data/"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"./datasets/"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the Ceará data:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>shpfile <span class="op">=</span> <span class="st">"ceara/ceara.shp"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>ensure_datasets(shpfile, folder_path <span class="op">=</span> path)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> gpd.read_file(path <span class="op">+</span> shpfile, encoding <span class="op">=</span> <span class="st">'utf-8'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dfs.shape)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>dfs.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(184, 36)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">code7</th>
<th data-quarto-table-cell-role="th">mun_name</th>
<th data-quarto-table-cell-role="th">state_init</th>
<th data-quarto-table-cell-role="th">area_km2</th>
<th data-quarto-table-cell-role="th">state_code</th>
<th data-quarto-table-cell-role="th">micro_code</th>
<th data-quarto-table-cell-role="th">micro_name</th>
<th data-quarto-table-cell-role="th">inc_mic_4q</th>
<th data-quarto-table-cell-role="th">inc_zik_3q</th>
<th data-quarto-table-cell-role="th">inc_zik_2q</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">gdp</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">gdpcap</th>
<th data-quarto-table-cell-role="th">popdens</th>
<th data-quarto-table-cell-role="th">zik_1q</th>
<th data-quarto-table-cell-role="th">ziq_2q</th>
<th data-quarto-table-cell-role="th">ziq_3q</th>
<th data-quarto-table-cell-role="th">zika_d</th>
<th data-quarto-table-cell-role="th">mic_d</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2300101.0</td>
<td>Abaiara</td>
<td>CE</td>
<td>180.833</td>
<td>23</td>
<td>23019</td>
<td>19ª Região Brejo Santo</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.00</td>
<td>...</td>
<td>35974.0</td>
<td>10496.0</td>
<td>3.427</td>
<td>58.043</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>POLYGON ((5433729.65 9186242.97, 5433688.546 9...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2300150.0</td>
<td>Acarape</td>
<td>CE</td>
<td>130.002</td>
<td>23</td>
<td>23003</td>
<td>3ª Região Maracanaú</td>
<td>6.380399</td>
<td>0.0</td>
<td>0.00</td>
<td>...</td>
<td>68314.0</td>
<td>15338.0</td>
<td>4.454</td>
<td>117.983</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
<td>POLYGON ((5476916.288 9533405.667, 5476798.561...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2300200.0</td>
<td>Acaraú</td>
<td>CE</td>
<td>842.471</td>
<td>23</td>
<td>23012</td>
<td>12ª Região Acaraú</td>
<td>0.000000</td>
<td>0.0</td>
<td>1.63</td>
<td>...</td>
<td>309490.0</td>
<td>57551.0</td>
<td>5.378</td>
<td>68.312</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>POLYGON ((5294389.783 9689469.144, 5294494.499...</td>
</tr>
</tbody>
</table>

<p>3 rows × 36 columns</p>
</div>
</div>
</div>
</section>
<section id="variables" class="level3" data-number="14.1.3">
<h3 data-number="14.1.3" class="anchored" data-anchor-id="variables"><span class="header-section-number">14.1.3</span> Variables</h3>
<p>We continue with the same set of variables as in the previous Chapters, listed in <a href="hierarchical_spatial_clustering.html#tbl-spatialcluster-vars" class="quarto-xref">Table&nbsp;<span>12.1</span></a>, and combine them in the list <code>varlist</code>.</p>
<div id="482f5c08" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>varlist <span class="op">=</span> [<span class="st">'mobility'</span>, <span class="st">'environ'</span>, <span class="st">'housing'</span>, <span class="st">'sanitation'</span>, <span class="st">'infra'</span>, <span class="st">'gdpcap'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pygeoda-data-preparation" class="level3" data-number="14.1.4">
<h3 data-number="14.1.4" class="anchored" data-anchor-id="pygeoda-data-preparation"><span class="header-section-number">14.1.4</span> Pygeoda Data Preparation</h3>
<p>We follow the same steps as in <a href="hierarchical_spatial_clustering.html" class="quarto-xref">Chapter&nbsp;<span>12</span></a> to set up a data set in the <code>pygeoda</code> internal format as <code>ceara_g</code> and to create queen contiguity spatial weights (<code>queen_w</code>). As in the previous Chapters, we create subsets with the relevant variables in both the <code>pygeoda</code> format (<code>data_g</code>) and as a GeoDataFrame (<code>data</code>).</p>
<div id="8d74ec17" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ceara_g <span class="op">=</span> pygeoda.<span class="bu">open</span>(dfs)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>queen_w <span class="op">=</span> pygeoda.queen_weights(ceara_g)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(queen_w)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> dfs[varlist]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>data_g <span class="op">=</span> ceara_g[varlist]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Weights Meta-data:
 number of observations:                  184
           is symmetric:                 True
               sparsity:  0.02953686200378072
        # min neighbors:                    1
        # max neighbors:                   13
       # mean neighbors:    5.434782608695652
     # median neighbors:                  5.0
           has isolates:                False
</code></pre>
</div>
</div>
<p>Finally, we set the number of clusters to 13. This differs from the empirical examples in Chapter 12 of the <em>GeoDa Cluster Book</em> due to the result for max-p obtained with <code>pygeoda</code> in <a href="partitioned_spatial_clustering.html" class="quarto-xref">Chapter&nbsp;<span>13</span></a>. For consistency, we set the number of clusters for the other methods to that value.</p>
<div id="557f6f4d" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>n_clusters <span class="op">=</span> <span class="dv">13</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="cluster-solutions" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="cluster-solutions"><span class="header-section-number">14.2</span> Cluster Solutions</h2>
<p>Before considering the validation measures, we compute the cluster solutions for hierarchical clustering (using <code>sklearn.AgglomerativeClustering</code>), K-Means (using <code>sklearn.KMeans</code>), and the spatially constrained clustering methods using <code>pygeoda</code>. For details on the arguments and helper functions, see the relevant Chapters.</p>
<p>For each cluster, we extract the <code>labels</code> and the <code>fit</code> using the respective helper functions.</p>
<p>To illustrate the internal validity measures, we will focus on Ward’s agglomerative clustering as an example of a standard method and on AZP with SCHC initial solution as an example of a spatially constrained cluster solution. For this, we also generate the cluster cardinalities. This is not illustrated for the other cluster solutions, but can be readily implemented.</p>
<section id="hierarchical-clustering" class="level3" data-number="14.2.1">
<h3 data-number="14.2.1" class="anchored" data-anchor-id="hierarchical-clustering"><span class="header-section-number">14.2.1</span> Hierarchical Clustering</h3>
<div id="8054882a" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>method <span class="op">=</span> <span class="st">'ward'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> StandardScaler().fit_transform(data)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>agg_clusters <span class="op">=</span> AgglomerativeClustering(n_clusters <span class="op">=</span> n_clusters, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                    linkage <span class="op">=</span> method, compute_distances <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>agg_clusters.fit(X)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>agg_labels <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">int</span>(label) <span class="cf">for</span> label <span class="kw">in</span> agg_clusters.labels_)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>agg_clusters_fit <span class="op">=</span> cluster_fit(data <span class="op">=</span> data, clustlabels <span class="op">=</span>agg_clusters.labels_,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                 n_clusters <span class="op">=</span> n_clusters, printopt <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>agg_stats <span class="op">=</span> cluster_stats(agg_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Labels  Cardinality
      0           16
      1           26
      2           29
      3            9
      4           14
      5            3
      6           26
      7           11
      8           20
      9            4
     10           15
     11           10
     12            1</code></pre>
</div>
</div>
</section>
<section id="k-means-clustering" class="level3" data-number="14.2.2">
<h3 data-number="14.2.2" class="anchored" data-anchor-id="k-means-clustering"><span class="header-section-number">14.2.2</span> K-Means Clustering</h3>
<div id="66e42867" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>kmeans_clusters <span class="op">=</span> KMeans(n_clusters <span class="op">=</span> n_clusters, n_init <span class="op">=</span> <span class="dv">150</span>, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                         random_state<span class="op">=</span><span class="dv">123456789</span>).fit(X) </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>kmeans_labels <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">int</span>(label) <span class="cf">for</span> label <span class="kw">in</span> kmeans_clusters.labels_)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>kmeans_clusters_fit <span class="op">=</span> cluster_fit(data <span class="op">=</span> data, </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                 clustlabels <span class="op">=</span> kmeans_clusters.labels_,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                 n_clusters <span class="op">=</span> n_clusters, printopt <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="schc-with-wards-linkage" class="level3" data-number="14.2.3">
<h3 data-number="14.2.3" class="anchored" data-anchor-id="schc-with-wards-linkage"><span class="header-section-number">14.2.3</span> SCHC with Ward’s Linkage</h3>
<div id="b45e8390" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>schc_clusters <span class="op">=</span> pygeoda.schc(n_clusters, queen_w, data_g, <span class="st">"ward"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>schc_labels <span class="op">=</span> schc_clusters[<span class="st">'Clusters'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="skater" class="level3" data-number="14.2.4">
<h3 data-number="14.2.4" class="anchored" data-anchor-id="skater"><span class="header-section-number">14.2.4</span> SKATER</h3>
<div id="44102708" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>skater_clusters <span class="op">=</span> pygeoda.skater(n_clusters, queen_w, data_g)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>skater_labels <span class="op">=</span> skater_clusters[<span class="st">'Clusters'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="redcap" class="level3" data-number="14.2.5">
<h3 data-number="14.2.5" class="anchored" data-anchor-id="redcap"><span class="header-section-number">14.2.5</span> REDCAP</h3>
<div id="9831e9c1" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>redcap_clusters <span class="op">=</span> pygeoda.redcap(n_clusters, queen_w, data_g, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                        method <span class="op">=</span> <span class="st">'fullorder-wardlinkage'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>redcap_labels <span class="op">=</span> redcap_clusters[<span class="st">'Clusters'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="azp-with-simulated-annealing" class="level3" data-number="14.2.6">
<h3 data-number="14.2.6" class="anchored" data-anchor-id="azp-with-simulated-annealing"><span class="header-section-number">14.2.6</span> AZP with Simulated Annealing</h3>
<div id="d7c0650a" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>azp_sa_clusters <span class="op">=</span> pygeoda.azp_sa(n_clusters, queen_w, data_g, </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                        cooling_rate <span class="op">=</span> <span class="fl">0.8</span>, sa_maxit <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>azp_sa_labels <span class="op">=</span> azp_sa_clusters[<span class="st">'Clusters'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="azp-with-schc-as-initial-solution" class="level3" data-number="14.2.7">
<h3 data-number="14.2.7" class="anchored" data-anchor-id="azp-with-schc-as-initial-solution"><span class="header-section-number">14.2.7</span> AZP with SCHC as Initial Solution</h3>
<div id="b98dd812" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>azp_schc_clusters <span class="op">=</span> pygeoda.azp_sa(n_clusters, queen_w, data_g, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                            cooling_rate <span class="op">=</span> <span class="fl">0.8</span>, sa_maxit <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                            init_regions <span class="op">=</span> schc_labels)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>azp_schc_labels <span class="op">=</span> azp_schc_clusters[<span class="st">'Clusters'</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>azp_schc_stats <span class="op">=</span> cluster_stats(azp_schc_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Labels  Cardinality
      1           89
      2           43
      3           15
      4           14
      5            6
      6            4
      7            4
      8            3
      9            2
     10            1
     11            1
     12            1
     13            1</code></pre>
</div>
</div>
</section>
<section id="max-p-regions" class="level3" data-number="14.2.8">
<h3 data-number="14.2.8" class="anchored" data-anchor-id="max-p-regions"><span class="header-section-number">14.2.8</span> Max-p Regions</h3>
<div id="1a2c31cd" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>maxp_sa_clusters <span class="op">=</span> pygeoda.maxp_sa(queen_w, data_g, </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                            bound_variable <span class="op">=</span> dfs[<span class="st">'pop'</span>], </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                            min_bound <span class="op">=</span> dfs[<span class="st">'pop'</span>].<span class="bu">sum</span>()<span class="op">*</span><span class="fl">0.05</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                            iterations <span class="op">=</span> <span class="dv">9999</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                            cooling_rate <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                            sa_maxit <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>maxp_sa_labels <span class="op">=</span> maxp_sa_clusters[<span class="st">'Clusters'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="internal-validation-measures" class="level2" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="internal-validation-measures"><span class="header-section-number">14.3</span> Internal Validation Measures</h2>
<p>As mentioned, in addition to the classic measures of fit, we also consider <em>fragmentation</em>, the <em>join count ratio</em>, and, for spatially constrained cluster solutions, the <em>compactness</em> and <em>diameter</em>.</p>
<p>These measures are provided as attributes in the solution object created by <code>pygeoda.spatial_validation</code>. This requires the <code>pygeoda</code> data set, the cluster labels and the spatial weights as arguments.</p>
<p>We illustrate this for Ward’s agglomerative clustering, with <code>agg_labels</code> as the cluster labels, and for AZP-SCHC, with <code>azp_schc_labels</code> as the cluster labels. For both, the data set is <code>ceara_g</code> and the spatial weights are contained in <code>queen_w</code>.</p>
<p>We store the results in, respectively, <code>agg_validation</code> and <code>azp_schc_validation</code>. These objects will then be used as arguments to the helper functions.</p>
<div id="ba5c9ff1" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>agg_validation <span class="op">=</span> pygeoda.spatial_validation(ceara_g, agg_labels, queen_w)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>azp_schc_validation <span class="op">=</span> pygeoda.spatial_validation(ceara_g, azp_schc_labels, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                                 queen_w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fragmentation" class="level3" data-number="14.3.1">
<h3 data-number="14.3.1" class="anchored" data-anchor-id="fragmentation"><span class="header-section-number">14.3.1</span> Fragmentation</h3>
<p>The fragmentation measures are computed from the makeup of the cluster components. An ideally balanced cluster is when each component has the same number of observations. This is quantified by means of entropy and its standardized counterpart, as well as by Simpson’s index and its standardized counterpart. For entropy, larger values suggest a greater balance, whereas for Simpson’s index, it is the other way around.</p>
<p>The <code>pygeoda.spatial_validation</code> return object includes the fragmentation information in two attributes: <code>fragmentation</code> and <code>cluster_fragmentation</code>. The first contains the overall measures, as well as the number of clusters, in <code>fragmentation.n</code>, <code>fragmentation.entropy</code>, <code>fragmentation.std_entropy</code>, <code>fragmentation.simpson</code> and <code>fragmentation.std_simpson</code>. The second has the same information, organized as a list by cluster. It shows the within-cluster fragmentation for clusters that are not spatially constrained.</p>
<p>The <code>cluster_fragmentation</code> helper function, takes a data frame with the labels and cardinalities (created by <code>cluster_stats</code>), and the <code>cluster_fragmentation</code>, <code>fragmentation</code> and <code>spatially_constrained</code> attributes from the validation object. The <code>spatially_constrained</code> flag is used to limit the fragmentation output to the totals only for spatially constrained clusters.</p>
<p>This is illustrated for Ward’s agglomerative clustering and AZP-SCHC. Note that for the latter, only the totals are given, since it is a spatially constrained solution.</p>
<p>The other cluster solutions can be analyzed in the same way.</p>
<section id="agglomerative-clustering" class="level4" data-number="14.3.1.1">
<h4 data-number="14.3.1.1" class="anchored" data-anchor-id="agglomerative-clustering"><span class="header-section-number">14.3.1.1</span> Agglomerative clustering</h4>
<div id="690e53ca" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>agg_frag <span class="op">=</span> cluster_fragmentation(agg_stats, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                   agg_validation.cluster_fragmentation,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                   agg_validation.fragmentation, </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                   agg_validation.spatially_constrained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fragmentation
Label   N Sub  Entropy  Entropy*  Simpson  Simpson*
    0  16   9 1.751176  0.796994 0.250892  2.258026
    1  26  14 2.397937  0.908634 0.115385  1.615385
    2  29  14 2.425806  0.919194 0.109467  1.532544
    3   9  11 2.250260  0.938431 0.120000  1.320000
    4  14   9 1.923066  0.875225 0.187500  1.687500
    5   3   8 1.933810  0.929966 0.164444  1.315556
    6  26  10 2.168223  0.941647 0.132653  1.326531
    7  11   9 2.145842  0.976615 0.123967  1.115702
    8  20   6 1.609438  0.898244 0.240000  1.440000
    9   4   7 1.831020  0.940958 0.185185  1.296296
   10  15   0 0.000000  0.000000 0.000000  0.000000
   11  10   3 1.098612  1.000000 0.333333  1.000000
   12   1   0 0.000000  0.000000 0.000000  0.000000
  All 184     2.351159  0.916649 0.106274  1.381557</code></pre>
</div>
</div>
</section>
<section id="azp-schc" class="level4" data-number="14.3.1.2">
<h4 data-number="14.3.1.2" class="anchored" data-anchor-id="azp-schc"><span class="header-section-number">14.3.1.2</span> AZP-SCHC</h4>
<div id="30ac358b" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>azp_schc_frag <span class="op">=</span> cluster_fragmentation(azp_schc_stats, </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                   azp_schc_validation.cluster_fragmentation,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                   azp_schc_validation.fragmentation, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                   azp_schc_validation.spatially_constrained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fragmentation
Label   N Sub  Entropy  Entropy*  Simpson  Simpson*
  All 184     1.599116  0.623449 0.303521   3.94577</code></pre>
</div>
</div>
</section>
</section>
<section id="join-count-ratio" class="level3" data-number="14.3.2">
<h3 data-number="14.3.2" class="anchored" data-anchor-id="join-count-ratio"><span class="header-section-number">14.3.2</span> Join Count Ratio</h3>
<p>The join count ratio is a <em>spatial</em> measure of the degree of internal connectedness in a cluster solution. It is computed for each cluster separately as well as for the cluster solution as a whole. It is a count of how many neighbors of observations in a cluster are also members of that cluster.</p>
<p>The relevant measures are included in the <code>joincount_ratio</code> and <code>all_joincount_ratio</code> attributes of the <code>pygeoda.spatial_validation</code> solution object. The former is a list with k entries, which are themselves objects, containing attributes <code>n</code>, <code>neighbors</code>, <code>join_count</code> and <code>ratio</code>. The latter is the same for the overall cluster solution.</p>
<p>The result is provided by the <code>cluster_joincount</code> helper function. It takes the data frame with cluster cardinalities and the <code>joincount_ratio</code> and <code>all_joincount_ratio</code> attributes from the validation solution.</p>
<p>We use the same examples in the illustration below.</p>
<section id="agglomerative-clustering-1" class="level4" data-number="14.3.2.1">
<h4 data-number="14.3.2.1" class="anchored" data-anchor-id="agglomerative-clustering-1"><span class="header-section-number">14.3.2.1</span> Agglomerative clustering</h4>
<div id="bcfc5dee" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>agg_jc <span class="op">=</span> cluster_joincount(agg_stats, agg_validation.joincount_ratio,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                   agg_validation.all_joincount_ratio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Join Count Ratio
Label   N  Neighbors  Join Count  Ratio
    0  16         96          20  0.208
    1  26        134          26  0.194
    2  29        158          64  0.405
    3   9         47           6  0.128
    4  14         80           8  0.100
    5   3         15           0  0.000
    6  26        158          30  0.190
    7  11         43           4  0.093
    8  20        116          18  0.155
    9   4         21          10  0.476
   10  15         83          18  0.217
   11  10         46           8  0.174
   12   1          3           0  0.000
  All 184       1000         212  0.212</code></pre>
</div>
</div>
</section>
<section id="azp-schc-1" class="level4" data-number="14.3.2.2">
<h4 data-number="14.3.2.2" class="anchored" data-anchor-id="azp-schc-1"><span class="header-section-number">14.3.2.2</span> AZP-SCHC</h4>
<div id="f4656f10" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>azp_schc_jc <span class="op">=</span> cluster_joincount(azp_schc_stats, </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                   azp_schc_validation.joincount_ratio,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                   azp_schc_validation.all_joincount_ratio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Join Count Ratio
Label   N  Neighbors  Join Count  Ratio
    0  89        474         342  0.722
    1  43        225         128  0.569
    2  15         96          42  0.438
    3  14         78          44  0.564
    4   6         37          10  0.270
    5   4         17           6  0.353
    6   4         21          10  0.476
    7   3         22           4  0.182
    8   2         12           2  0.167
    9   1          3           0  0.000
   10   1          3           0  0.000
   11   1          7           0  0.000
   12   1          5           0  0.000
  All 184       1000         588  0.588</code></pre>
</div>
</div>
</section>
</section>
<section id="compactness" class="level3" data-number="14.3.3">
<h3 data-number="14.3.3" class="anchored" data-anchor-id="compactness"><span class="header-section-number">14.3.3</span> Compactness</h3>
<p>Compactness is a criterion that is only applicable to spatially constrained cluster solutions. It measures the ratio of the perimeter of the cluster to that of a circle with the same area. The <code>compactness</code> attribute of the <code>spatial_validation</code> object is a list with k items, each an object with attributes <code>area</code>, <code>perimeter</code> and <code>isoperimeter_quotient</code>. The closer the IPQ is to one, the more compact is the cluster shape.</p>
<p>The helper function <code>cluster_compactness</code> extracts this information. Its attributes are the data frame with cluster cardinalities (from <code>cluster_stats</code>), the <code>compactness</code> attribute, and the <code>spatially_constrained</code> attribute. Compactness is not relevant for clusters that are not spatially constrained and therefore the helper function will yield an error message when this happens.</p>
<p>We continue with the same two examples. Note that for Ward’s agglomerative cluster, an error message is generated.</p>
<section id="agglomerative-clustering-2" class="level4" data-number="14.3.3.1">
<h4 data-number="14.3.3.1" class="anchored" data-anchor-id="agglomerative-clustering-2"><span class="header-section-number">14.3.3.1</span> Agglomerative clustering</h4>
<div id="d5c2a0b3" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>agg_compactness <span class="op">=</span> cluster_compactness(agg_stats, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                                agg_validation.compactness,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                                agg_validation.spatially_constrained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error: Compactness is only applicable to spatially constrained clusters</code></pre>
</div>
</div>
</section>
<section id="azp-schc-2" class="level4" data-number="14.3.3.2">
<h4 data-number="14.3.3.2" class="anchored" data-anchor-id="azp-schc-2"><span class="header-section-number">14.3.3.2</span> AZP-SCHC</h4>
<div id="dd82ab5b" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>azp_schc_compactness <span class="op">=</span> cluster_compactness(azp_schc_stats, </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                                azp_schc_validation.compactness,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                                azp_schc_validation.spatially_constrained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Compactness
 Label  N         Area    Perimeter      IPQ
     0 89 8.672968e+10 1.536222e+07 0.004618
     1 43 2.797625e+10 6.198588e+06 0.009150
     2 15 1.053291e+10 2.220946e+06 0.026834
     3 14 1.138704e+10 2.122643e+06 0.031759
     4  6 4.038275e+09 9.257796e+05 0.059209
     5  4 3.085985e+09 5.499120e+05 0.128238
     6  4 1.779537e+09 4.240068e+05 0.124386
     7  3 9.969357e+08 3.168568e+05 0.124782
     8  2 1.474872e+09 3.229358e+05 0.177718
     9  1 6.171934e+08 1.199243e+05 0.539283
    10  1 7.908164e+07 5.056877e+04 0.388616
    11  1 8.449201e+08 1.739887e+05 0.350738
    12  1 4.124364e+08 1.255397e+05 0.328855</code></pre>
</div>
</div>
</section>
</section>
<section id="diameter" class="level3" data-number="14.3.4">
<h3 data-number="14.3.4" class="anchored" data-anchor-id="diameter"><span class="header-section-number">14.3.4</span> Diameter</h3>
<p>The diameter of a spatially constrained cluster is an alternative measure of compactness, based on the network structure reflected in the spatial weights. The diameter of a cluster is the number of steps in the spatial weights graph that corresponds with the longest shortest path between any pair of observations <span class="citation" data-cites="Newman18">(<a href="bibliography.html#ref-Newman18" role="doc-biblioref">Newman 2018</a>)</span>. Since this number will increase with cluster size, it is also standardized by dividing by the number of cluster members. Note that when a cluster is a singleton, the diameter will be zero.</p>
<p>The <code>diameter</code> attribute of the <code>pygeoda.spatial_validation</code> object is a list with k items, one for each cluster, as an object with attributes <code>steps</code> and <code>ratio</code>. The helper function <code>cluster_diameter</code> extracts this information as a data frame. It takes as arguments the cluster cardinalities (from <code>cluster_stats</code>), and the <code>diameter</code> and <code>spatially_constrained</code> attributes from the <code>pygeoda.spatial_validation</code> object.</p>
<p>As in the case of compactness, an error message is generated for clusters that are not spatially constrained.</p>
<p>Again, we use the same two examples.</p>
<section id="agglomerative-clustering-3" class="level4" data-number="14.3.4.1">
<h4 data-number="14.3.4.1" class="anchored" data-anchor-id="agglomerative-clustering-3"><span class="header-section-number">14.3.4.1</span> Agglomerative clustering</h4>
<div id="4885a986" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>agg_diam <span class="op">=</span> cluster_diameter(agg_stats, agg_validation.diameter,</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                            agg_validation.spatially_constrained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error: Diameter is only applicable to spatially constrained clusters</code></pre>
</div>
</div>
</section>
<section id="azp-schc-3" class="level4" data-number="14.3.4.2">
<h4 data-number="14.3.4.2" class="anchored" data-anchor-id="azp-schc-3"><span class="header-section-number">14.3.4.2</span> AZP-SCHC</h4>
<div id="27b3b1cd" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>azp_schc_diam <span class="op">=</span> cluster_diameter(azp_schc_stats, azp_schc_validation.diameter,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                            azp_schc_validation.spatially_constrained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Diameter
 Label  N  Steps    Ratio
     0 89     22 0.247191
     1 43     17 0.395349
     2 15      6 0.400000
     3 14      7 0.500000
     4  6      3 0.500000
     5  4      3 0.750000
     6  4      2 0.500000
     7  3      2 0.666667
     8  2      1 0.500000
     9  1      0 0.000000
    10  1      0 0.000000
    11  1      0 0.000000
    12  1      0 0.000000</code></pre>
</div>
</div>
</section>
</section>
<section id="overall-comparison-of-internal-validation-measures" class="level3" data-number="14.3.5">
<h3 data-number="14.3.5" class="anchored" data-anchor-id="overall-comparison-of-internal-validation-measures"><span class="header-section-number">14.3.5</span> Overall Comparison of Internal Validation Measures</h3>
<p>We conclude our discussion of internal validation measures with an overview of the main non-spatial measures for all the cluster solutions considered above.</p>
<div id="6586219c" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>clusters <span class="op">=</span> [</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    agg_clusters_fit, kmeans_clusters_fit, schc_clusters, skater_clusters,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    redcap_clusters, azp_sa_clusters, azp_schc_clusters, maxp_sa_clusters</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    agg_labels, kmeans_labels, schc_labels, skater_labels,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    redcap_labels, azp_sa_labels, azp_schc_labels, maxp_sa_labels</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>label_names <span class="op">=</span> [</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Hierarchical'</span>, <span class="st">'K-Means'</span>, <span class="st">'SCHC'</span>, <span class="st">'SKATER'</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'REDCAP'</span>, <span class="st">'AZP'</span>, <span class="st">'AZP_Initial'</span>, <span class="st">'Max-p'</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Run pygeoda.spatial_validation for each label set</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster, label, name <span class="kw">in</span> <span class="bu">zip</span>(clusters, labels, label_names):</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pygeoda.spatial_validation(ceara_g, label, queen_w)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        wss <span class="op">=</span> np.<span class="bu">round</span>(cluster[<span class="st">'Total within-cluster sum of squares'</span>], <span class="dv">4</span>)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        bss_tss <span class="op">=</span> np.<span class="bu">round</span>(cluster[<span class="st">'The ratio of between to total sum of squares'</span>], <span class="dv">4</span>)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>            wss <span class="op">=</span> np.<span class="bu">round</span>(cluster[<span class="st">"WSS"</span>], <span class="dv">2</span>)</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>            bss_tss <span class="op">=</span> np.<span class="bu">round</span>(cluster[<span class="st">"Ratio"</span>], <span class="dv">2</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>            wss <span class="op">=</span> <span class="va">None</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>            bss_tss <span class="op">=</span> <span class="va">None</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    spatially_constrained <span class="op">=</span> result.spatially_constrained</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    all_join_count_ratio <span class="op">=</span> np.<span class="bu">round</span>(result.all_joincount_ratio.ratio, <span class="dv">4</span>)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    entropy <span class="op">=</span> np.<span class="bu">round</span>(result.fragmentation.entropy, <span class="dv">4</span>)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    simpson <span class="op">=</span> np.<span class="bu">round</span>(result.fragmentation.simpson, <span class="dv">4</span>)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    results.append({</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Method'</span>: name,</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Spat. Const.'</span>: spatially_constrained,</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'WSS'</span>: wss,</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'BSS/TSS'</span>: bss_tss,</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Join Count'</span>: all_join_count_ratio,</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Entropy'</span>: entropy,</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Simpson'</span>: simpson</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>validation <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(validation.to_string(index <span class="op">=</span> <span class="va">False</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Method  Spat. Const.      WSS  BSS/TSS  Join Count  Entropy  Simpson
Hierarchical         False 349.0000   0.6800       0.212   2.3512   0.1063
     K-Means         False 334.3800   0.7000       0.240   2.3213   0.1112
        SCHC          True 568.0173   0.4827       0.668   1.6394   0.2730
      SKATER          True 604.2209   0.4497       0.784   1.3661   0.3901
      REDCAP          True 562.7003   0.4875       0.660   1.6109   0.2769
         AZP          True 617.0010   0.4381       0.526   1.9521   0.2016
 AZP_Initial          True 538.3477   0.5097       0.588   1.5991   0.3035
       Max-p          True 745.2474   0.3213       0.496   2.4175   0.0959</code></pre>
</div>
</div>
</section>
</section>
<section id="external-validation-measures" class="level2" data-number="14.4">
<h2 data-number="14.4" class="anchored" data-anchor-id="external-validation-measures"><span class="header-section-number">14.4</span> External Validation Measures</h2>
<p>External validation measures are designed to compare a cluster solution to a <em>truth</em>, but they can also be employed to compare several cluster solutions to each other. The validation indices reveal how close the cluster solutions are. We consider two measures, the <em>adjusted rand index</em> and the <em>normalized information distance</em>.</p>
<section id="adjusted-rand-index-ari" class="level3" data-number="14.4.1">
<h3 data-number="14.4.1" class="anchored" data-anchor-id="adjusted-rand-index-ari"><span class="header-section-number">14.4.1</span> Adjusted Rand Index (ARI)</h3>
<p>The adjusted rand index is based on counting how many pairs of observations are in the same grouping for two cluster solutions. It can be computed by <code>sklearn.metrics.adjusted_rand_score</code>. The two arguments are numpy arrays of the labels of the <em>reference</em> (first argument) and the labels of the cluster to be compared.</p>
<p>Note that we need to convert our <code>labels</code> solution to a numpy array to make this work.</p>
<p>For example, the ARI between Ward’s agglomerative solution and K-Means is found by passing numpy arrays for <code>agg_labels</code> and <code>kmeans_labels</code>. The result smaller than 0.5 suggests only low correspondence.</p>
<div id="107f3fa3" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ari <span class="op">=</span> adjusted_rand_score(np.array(agg_labels), np.array(kmeans_labels))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">round</span>(ari, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.392</code></pre>
</div>
</div>
<p>We can now compute all pairwise indices with a simple loop. We first recreate the <code>labels</code> and <code>label_names</code> lists from above (so this can be run without the internal validation measures).</p>
<div id="84e3f9a3" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    agg_labels, kmeans_labels, schc_labels, skater_labels,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    redcap_labels, azp_sa_labels, azp_schc_labels, maxp_sa_labels</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>label_names <span class="op">=</span> [</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Hierarchical'</span>, <span class="st">'K-Means'</span>, <span class="st">'SCHC'</span>, <span class="st">'SKATER'</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'REDCAP'</span>, <span class="st">'AZP'</span>, <span class="st">'AZP_Initial'</span>, <span class="st">'Max-p'</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In a simple loop, we compute all pairwise indices and populate a matrix. This is then turned into a data frame and printed. Note that the matrix is symmetric and the diagonal values of 1.0 can be ignored.</p>
<div id="791ce3bf" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> <span class="bu">len</span>(labels)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>allari <span class="op">=</span> np.zeros((h, h))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(h):</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    labi <span class="op">=</span> np.array(labels[i])</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(h):</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        labj <span class="op">=</span> np.array(labels[j])</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        allari[i,j] <span class="op">=</span> adjusted_rand_score(labi, labj)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>dfari <span class="op">=</span> pd.DataFrame(allari, columns <span class="op">=</span> label_names, index <span class="op">=</span> label_names)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">round</span>(dfari, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Hierarchical  K-Means   SCHC  SKATER  REDCAP    AZP  \
Hierarchical         1.000    0.392  0.131   0.079   0.145  0.160   
K-Means              0.392    1.000  0.176   0.095   0.184  0.205   
SCHC                 0.131    0.176  1.000   0.424   0.918  0.504   
SKATER               0.079    0.095  0.424   1.000   0.384  0.258   
REDCAP               0.145    0.184  0.918   0.384   1.000  0.516   
AZP                  0.160    0.205  0.504   0.258   0.516  1.000   
AZP_Initial          0.155    0.165  0.735   0.452   0.727  0.577   
Max-p                0.089    0.091  0.194   0.173   0.185  0.218   

              AZP_Initial  Max-p  
Hierarchical        0.155  0.089  
K-Means             0.165  0.091  
SCHC                0.735  0.194  
SKATER              0.452  0.173  
REDCAP              0.727  0.185  
AZP                 0.577  0.218  
AZP_Initial         1.000  0.163  
Max-p               0.163  1.000  </code></pre>
</div>
</div>
<p>As in Chapter 12 of the <em>GeoDa Cluster Book</em>, the matrix reveals a much closer correspondence among the non-spatial solutions and the spatial solutions respectively. The greatest correspondence is between SCHC and Redcap, with an ARI of 0.918.</p>
</section>
<section id="normalized-information-distance-nid" class="level3" data-number="14.4.2">
<h3 data-number="14.4.2" class="anchored" data-anchor-id="normalized-information-distance-nid"><span class="header-section-number">14.4.2</span> Normalized Information Distance (NID)</h3>
<p>The second external validation measure is based on information-theoretic considerations, such as entropy. In Chapter 12 of the <em>GeoDa Cluster Book</em>, the normalized information distance is introduced (NID). A close counterpart can be computed by means of <code>sklearn.metrics.adjusted_mutual_info_score</code>. The arguments are the same as for ARI. However, in contrast to NID as presented in the <em>GeoDa Cluster Book</em>, a higher value for the adjusted mutual information score indicates closer similarity.</p>
<p>We first illustrate this for Ward’s agglomerative clustering and K-Means, passing numpy arrays of <code>agg_labels</code> and <code>kmeans_labels</code>.</p>
<div id="9a61c8f1" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>nid <span class="op">=</span> adjusted_mutual_info_score(np.array(agg_labels), np.array(kmeans_labels))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">round</span>(nid, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.614</code></pre>
</div>
</div>
<p>Finally, we run the same loop as for ARI to compute all pairwise NID scores.</p>
<div id="e473b192" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>allnid <span class="op">=</span> np.zeros((h, h))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(h):</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    labi <span class="op">=</span> np.array(labels[i])</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(h):</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        labj <span class="op">=</span> np.array(labels[j])</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        allnid[i,j] <span class="op">=</span> adjusted_mutual_info_score(labi, labj)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>dfnid <span class="op">=</span> pd.DataFrame(allnid, columns <span class="op">=</span> label_names, index <span class="op">=</span> label_names)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">round</span>(dfnid, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Hierarchical  K-Means   SCHC  SKATER  REDCAP    AZP  \
Hierarchical         1.000    0.614  0.257   0.219   0.267  0.306   
K-Means              0.614    1.000  0.300   0.244   0.308  0.328   
SCHC                 0.257    0.300  1.000   0.548   0.897  0.581   
SKATER               0.219    0.244  0.548   1.000   0.496  0.425   
REDCAP               0.267    0.308  0.897   0.496   1.000  0.595   
AZP                  0.306    0.328  0.581   0.425   0.595  1.000   
AZP_Initial          0.317    0.322  0.727   0.545   0.727  0.646   
Max-p                0.177    0.191  0.388   0.423   0.372  0.445   

              AZP_Initial  Max-p  
Hierarchical        0.317  0.177  
K-Means             0.322  0.191  
SCHC                0.727  0.388  
SKATER              0.545  0.423  
REDCAP              0.727  0.372  
AZP                 0.646  0.445  
AZP_Initial         1.000  0.367  
Max-p               0.367  1.000  </code></pre>
</div>
</div>
<p>As for ARI, we find the closest correspondence between SCHC and Redcap.</p>
</section>
</section>
<section id="practice" class="level2" data-number="14.5">
<h2 data-number="14.5" class="anchored" data-anchor-id="practice"><span class="header-section-number">14.5</span> Practice</h2>
<p>We now have all the available tools to compare the various cluster solutions obtained in earlier Chapters. In addition, when an administrative regionalization is available (e.g., subdistricts in a city), the various cluster solutions can be compared to that <em>truth</em>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-HubertArabie85" class="csl-entry" role="listitem">
Hubert, Lawrence J., and Phipps Arabie. 1985. <span>“Comparing Partitions.”</span> <em>Journal of Classification</em> 2: 193–218.
</div>
<div id="ref-Newman18" class="csl-entry" role="listitem">
Newman, Mark. 2018. <em>Networks</em>. Oxford, United Kingdom: Oxford University Press.
</div>
<div id="ref-Vinhetal10" class="csl-entry" role="listitem">
Vinh, Nguyen Xuan, Julien Epps, and James Bailey. 2010. <span>“Information Theoretic Measures for Clustering Comparison: Variants, Properties, Normalization and Correction for Chance.”</span> <em>Journal of Machine Learning Research</em> 11: 2837–54.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./partitioned_spatial_clustering.html" class="pagination-link" aria-label="Spatially Constrained Clustering - Partitioning Methods">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Spatially Constrained Clustering - Partitioning Methods</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./bibliography.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2025 GeoDa Press LLC, All Rights Reserved</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>